asyncapi: "2.6.0"
info:
  title: Viewer API
  version: "0.1.0"
channels:
  /competition/updates:
    subscribe:
      message:
        $ref: "#/components/messages/CompetitionUpdate"
  /competition/control:
    subscribe:
      message:
        $ref: "#/components/messages/HostConfiguration"
    publish:
      message:
        oneOf:
          - $ref: "#/components/messages/CompetitionControlCommand"
          - $ref: "#/components/messages/HostConfiguration"
components:
  messages:
    CompetitionControlCommand:
      payload:
        type: object
        additionalProperties: false
        required:
          - messageType
          - command
        properties:
          messageType:
            type: string
            const: COMPETITION_CONTROL_COMMAND
          command:
            type: string
            enum:
              - START
              - END
              - RESET
              - GET_HOST_CONFIGURATION
    CompetitionUpdate:
      payload:
        type: object
        additionalProperties: false
        properties:
          messageType:
            type: string
            const: COMPETITION_UPDATE
          cameras:
            type: array
            items:
              type: object
              additionalProperties: false
              required:
                - cameraId
                - frameData
              properties:
                cameraId:
                  type: integer
                frameData:
                  type: string
                  format: binary
          chunks:
            type: array
            items:
              type: object
              additionalProperties: false
              required:
                - chunkId
                - height
                - position
              properties:
                chunkId:
                  type: integer
                height:
                  type: integer
                position:
                  $ref: "#/components/schemas/Position"
          events:
            type: array
            items:
              oneOf:
                - $ref: "#/components/schemas/PlayerAttackEvent"
                - $ref: "#/components/schemas/PlayerDigEvent"
                - $ref: "#/components/schemas/PlayerPickUpEvent"
                - $ref: "#/components/schemas/PlayerPlaceBlockEvent"
                - $ref: "#/components/schemas/PlayerTryAttackEvent"
                - $ref: "#/components/schemas/PlayerTryUseEvent"
          info:
            type: object
            additionalProperties: false
            required:
              - elapsedTime
              - stage
            properties:
              elapsedTime:
                type: integer
              stage:
                type: string
                enum:
                  - READY
                  - RUNNING
                  - BATTLING
                  - FINISHED
          mines:
            type: array
            items:
              type: object
              additionalProperties: false
              required:
                - mineId
                - accumulatedOreCount
                - oreType
                - position
              properties:
                mineId:
                  type: integer
                accumulatedOreCount:
                  type: integer
                oreType:
                  type: string
                  enum:
                    - IRON_ORE
                    - GOLD_ORE
                    - DIAMOND_ORE
                position:
                  $ref: "#/components/schemas/Position"
          players:
            type: array
            additionalProperties: false
            required:
              - playerId
              - attributes
              - health
              - homePosition
              - inventory
              - position
            properties:
              playerId:
                type: integer
              attributes:
                type: object
                additionalProperties: false
                required:
                  - agility
                  - maxHealth
                  - strength
                properties:
                  agility:
                    type: integer
                  maxHealth:
                    type: integer
                  strength:
                    type: integer
              health:
                type: integer
              homePosition:
                $ref: "#/components/schemas/Position"
              inventory:
                type: object
                additionalProperties: false
                required:
                  - emerald
                  - wool
                properties:
                  emerald:
                    type: integer
                  wool:
                    type: integer
              position:
                $ref: "#/components/schemas/Position"
    HostConfiguration:
      payload:
        type: object
        additionalProperties: false
        required:
          - messageType
          - availabelCameraIds
          - availableSerialPortNames
          - players
        properties:
          messageType:
            type: string
            const: HOST_CONFIGURATION
          availableCameras:
            type: array
            items:
              type: integer
          availableSerialPorts:
            type: array
            items:
              type: string
          players:
            type: array
            items:
              type: object
              additionalProperties: false
              required:
                - playerId
                - camera
                - serialPort
              properties:
                playerId:
                  type: integer
                camera:
                  type: object
                  additionalProperties: false
                  required:
                    - cameraId
                    - calibration
                    - recognition
                  properties:
                    cameraId:
                      type: integer
                    calibration:
                      type: object
                      additionalProperties: false
                      required:
                        - topLeft
                        - topRight
                        - bottomLeft
                        - bottomRight
                      properties:
                        topLeft:
                          $ref: "#/components/schemas/Position"
                        topRight:
                          $ref: "#/components/schemas/Position"
                        bottomLeft:
                          $ref: "#/components/schemas/Position"
                        bottomRight:
                          $ref: "#/components/schemas/Position"
                    recognition:
                      type: object
                      additionalProperties: false
                      required:
                        - hueCenter
                        - hueRange
                        - saturationCenter
                        - saturationRange
                        - valueCenter
                        - valueRange
                        - minArea
                        - showMask
                      properties:
                        hueCenter:
                          type: number
                        hueRange:
                          type: number
                        saturationCenter:
                          type: number
                        saturationRange:
                          type: number
                        valueCenter:
                          type: number
                        valueRange:
                          type: number
                        minArea:
                          type: number
                        showMask:
                          type: boolean
                serialPort:
                  type: object
                  additionalProperties: false
                  required:
                    - portName
                    - baudRate
                  properties:
                    portName:
                      type: string
                    baudRate:
                      type: integer
  schemas:
    Position:
      type: object
      additionalProperties: false
      required:
        - x
        - y
      properties:
        x:
          type: number
        y:
          type: number
    PlayerAttackEvent:
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetPlayerId
      properties:
        eventType:
          type: string
          const: PLAYER_ATTACK
        playerId:
          type: integer
        targetPlayerId:
          type: integer
    PlayerDigEvent:
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetChunk
      properties:
        eventType:
          type: string
          const: PLAYER_DIG
        playerId:
          type: integer
        targetChunk:
          type: integer
    PlayerPickUpEvent:
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - itemType
        - itemCount
      properties:
        eventType:
          type: string
          const: PLAYER_PICK_UP
        playerId:
          type: integer
        itemType:
          type: string
          enum:
            - IRON_INGOT
            - GOLD_INGOT
            - DIAMOND
        itemCount:
          type: integer
    PlayerPlaceBlockEvent:
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - blockType
      properties:
        eventType:
          type: string
          const: PLAYER_PLACE_BLOCK
        playerId:
          type: integer
        blockType:
          type: string
          enum:
            - WOOL
    PlayerTryAttackEvent:
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetChunk
      properties:
        eventType:
          type: string
          const: PLAYER_TRY_ATTACK
        playerId:
          type: integer
        targetChunk:
          type: integer
    PlayerTryUseEvent:
      type: object
      additionalProperties: false
      required:
        - eventType
        - playerId
        - targetChunk
      properties:
        eventType:
          type: string
          const: PLAYER_TRY_USE
        playerId:
          type: integer
        targetChunk:
          type: integer
